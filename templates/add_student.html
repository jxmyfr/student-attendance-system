{% extends 'base.html' %}
{% block title %}‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Enroll Face){% endblock %}
{% block content %}
<style>
    .enroll-container { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); padding: 30px; display: flex; gap: 30px; flex-wrap: wrap; }
    .form-section { flex: 1; min-width: 300px; }
    .camera-section { flex: 1; min-width: 300px; text-align: center; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold; }
    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ Dropdown ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
    .form-group select, .form-group input { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-family: 'Sarabun', sans-serif; font-size: 15px; background-color: #f8fafc; }
    .form-group select:focus { border-color: #3182ce; outline: none; }
    
    #videoElement { width: 100%; max-width: 400px; border-radius: 8px; border: 3px solid #2d3748; background: #000; transform: scaleX(-1); }
    
    .btn-action { background-color: #3182ce; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 15px; cursor: pointer; flex: 1; font-family: 'Sarabun'; transition: 0.3s; }
    .btn-action:hover { background-color: #2b6cb0; }
    .btn-action:disabled { background-color: #a0aec0; cursor: not-allowed; }
    
    .btn-upload { background-color: #48bb78; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 15px; cursor: pointer; flex: 1; font-family: 'Sarabun'; transition: 0.3s; }
    .btn-upload:hover { background-color: #38a169; }

    .btn-save { background-color: #ed8936; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; font-family: 'Sarabun'; transition: 0.3s; margin-top: 15px; }
    .btn-save:hover { background-color: #dd6b20; }
    
    .status-text { margin-top: 15px; font-weight: bold; color: #4a5568; }
    #snapshots { display: flex; gap: 5px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
    #snapshots img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; border: 2px solid #48bb78; }
</style>

<div class="enroll-container">
    <div class="form-section">
        <h3 style="margin-top: 0; color: #2d3748;"><i class="fas fa-list-ul"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        
        <div class="form-group">
            <label>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏´‡πâ‡∏≠‡∏á</label>
            <select id="stu_class" onchange="loadStudents()">
                <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... --</option>
            </select>
        </div>

        <div class="form-group">
            <label>2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <select id="stu_id">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>
            </select>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #ebf8ff; border-radius: 8px; font-size: 0.9rem; color: #2b6cb0;">
            <i class="fas fa-info-circle"></i> <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô
        </div>
    </div>

    <div class="camera-section">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-action" id="captureBtn" onclick="startCapture()">
                <i class="fas fa-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡∏Å‡∏•‡πâ‡∏≠‡∏á)
            </button>
            <button class="btn-upload" onclick="document.getElementById('fileUpload').click()">
                <i class="fas fa-folder-open"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            <input type="file" id="fileUpload" multiple accept="image/*" style="display: none;">
        </div>

        <div id="snapshots"></div>
        <p class="status-text" id="statusText">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
        
        <button class="btn-save" id="saveBtn" style="display: none;" onclick="submitDataToServer()">
            <i class="fas fa-save"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        </button>
    </div>
</div>

<script>
    // --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dropdown ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
    window.onload = function() {
        fetch('/api/classes')
            .then(response => response.json())
            .then(classes => {
                const classSelect = document.getElementById('stu_class');
                classSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
                classes.forEach(c => {
                    let opt = document.createElement('option');
                    opt.value = c;
                    opt.innerHTML = c;
                    classSelect.appendChild(opt);
                });
            });
    };

    // --- ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
    function loadStudents() {
        const className = document.getElementById('stu_class').value;
        const studentSelect = document.getElementById('stu_id');
        
        if (!className) {
            studentSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>';
            return;
        }

        studentSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠... --</option>';
        fetch(`/api/students/${encodeURIComponent(className)}`)
            .then(response => response.json())
            .then(students => {
                studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
                students.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s.id;
                    opt.innerHTML = `${s.id} - ${s.name_th}`;
                    studentSelect.appendChild(opt);
                });
            });
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å Dropdown) ---
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let capturedImages = [];

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { video.srcObject = stream; })
        .catch(err => { console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ", err); });

    function startCapture() {
        const studentId = document.getElementById('stu_id').value;
        if (!studentId) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Dropdown ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!"); return; }

        const btn = document.getElementById('captureBtn');
        const status = document.getElementById('statusText');
        btn.disabled = true;
        capturedImages = [];
        document.getElementById('snapshots').innerHTML = '';
        document.getElementById('saveBtn').style.display = 'none';
        status.style.color = '#3182ce';

        let count = 0;
        let captureInterval = setInterval(() => {
            count++;
            status.innerText = `üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${count}/5 ...`;
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedImages.push(canvas.toDataURL('image/jpeg', 0.9));

            const imgTag = document.createElement('img');
            imgTag.src = capturedImages[capturedImages.length - 1];
            document.getElementById('snapshots').appendChild(imgTag);

            if (count >= 5) {
                clearInterval(captureInterval);
                btn.disabled = false;
                status.innerText = "‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö 5 ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                status.style.color = '#48bb78';
                document.getElementById('saveBtn').style.display = 'block';
            }
        }, 800);
    }

    document.getElementById('fileUpload').addEventListener('change', function(e) {
        if (!document.getElementById('stu_id').value) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!"); this.value = ''; return;
        }
        const files = e.target.files;
        if (files.length === 0) return;

        capturedImages = []; document.getElementById('snapshots').innerHTML = '';
        const status = document.getElementById('statusText');
        status.innerText = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...`;

        let loadedCount = 0;
        Array.from(files).forEach((file, index) => {
            if(index >= 5) return; 
            const reader = new FileReader();
            reader.onload = function(event) {
                capturedImages.push(event.target.result);
                const imgTag = document.createElement('img');
                imgTag.src = event.target.result;
                document.getElementById('snapshots').appendChild(imgTag);
                loadedCount++;
                if (loadedCount === Math.min(files.length, 5)) {
                    status.innerText = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${loadedCount} ‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`;
                    status.style.color = '#48bb78';
                    document.getElementById('saveBtn').style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        });
    });

    function submitDataToServer() {
        const studentId = document.getElementById('stu_id').value;
        const studentNameText = document.getElementById('stu_id').options[document.getElementById('stu_id').selectedIndex].text;
        // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏±‡∏î‡∏£‡∏´‡∏±‡∏™‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏¥‡πâ‡∏á)
        const name_th = studentNameText.split(' - ')[1] || "";
        const classroom = document.getElementById('stu_class').value;

        if(!studentId || capturedImages.length === 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!"); return;
        }

        const status = document.getElementById('statusText');
        const saveBtn = document.getElementById('saveBtn');
        status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
        status.style.color = '#ed8936';
        saveBtn.disabled = true;

        const payload = {
            student_id: studentId,
            name_th: name_th,
            name_en: "", // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡πÉ‡∏ô DB ‡πÅ‡∏•‡πâ‡∏ß
            classroom: classroom,
            images: capturedImages
        };

        fetch('/register_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert("üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
                window.location.href = "/students";
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
                saveBtn.disabled = false;
            }
        });
    }
</script>
{% endblock %}