{% extends 'base.html' %} {% block title %}ภาพรวมสถิติการเข้าเรียน{% endblock %}
{% block content %}

<style>
  :root {
    --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }
  .modern-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    border: none;
    transition: 0.3s;
  }
  .stat-label {
    color: #a0aec0;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #2d3748;
    margin: 5px 0;
  }
  .trend-up {
    color: #48bb78;
    font-size: 0.85rem;
    font-weight: bold;
  }

  /* สไตล์ Ranking */
  .ranking-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 0;
    border-bottom: 1px solid #f7fafc;
  }
  .rank-number {
    width: 30px;
    height: 30px;
    background: #3182ce;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8rem;
  }

  /* สไตล์การ์ดตัวเลือกเดิม */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 20px;
  }
  .level-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    box-shadow: var(--card-shadow);
    cursor: pointer;
    transition: 0.2s;
    border-bottom: 5px solid #3182ce;
  }
  .level-card:hover {
    transform: translateY(-5px);
  }
  .stat-badge {
    display: inline-block;
    background: #ebf8ff;
    color: #2b6cb0;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    margin-top: 10px;
  }
</style>

<div
  style="
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  "
>
  <div class="modern-card" style="border-left: 5px solid #3182ce">
    <div class="stat-label">นักเรียนทั้งหมด</div>
    <div class="stat-value">{{ summary.total_students }} คน</div>
    <div style="color: #718096; font-size: 0.85rem">
      <i class="fas fa-users"></i> ข้อมูลรายชื่อในระบบ
    </div>
  </div>
  <div class="modern-card" style="border-left: 5px solid #48bb78">
    <div class="stat-label">มาเรียนเฉลี่ย (ทั้งโรงเรียน)</div>
    <div class="stat-value" id="statRate">
      {{ summary.avg_attendance_rate }}%
    </div>
    <div class="trend-up">▲ อัปเดตล่าสุดวันนี้</div>
  </div>
</div>

<div
  id="analyticsSection"
  style="
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 25px;
    margin-bottom: 30px;
  "
>
  <div class="modern-card">
    <h3 id="currentViewTitle" style="margin-bottom: 20px; color: #2d3748">
      สถิติการเข้าเรียนแยกตามชั้นเรียน
    </h3>
    <div style="height: 350px">
      <canvas id="overallChart"></canvas>
    </div>
  </div>

  <div class="modern-card">
    <h3 style="margin-bottom: 20px">อันดับห้องเรียนยอดเยี่ยม</h3>
    <div id="rankingList">
      <p style="color: #a0aec0; text-align: center; padding-top: 20px">
        กำลังประมวลผลอันดับ...
      </p>
    </div>
  </div>
</div>

<div
  class="dash-header"
  style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px"
>
  <button
    onclick="goBack()"
    id="backBtn"
    style="
      display: none;
      align-items: center;
      justify-content: center;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: white;
      color: #4a5568;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: 0.2s;
      flex-shrink: 0; /* ป้องกันปุ่มถูกบีบ */
    "
  >
    <i class="fas fa-arrow-left" style="font-size: 1.2rem"></i>
  </button>
  <div
    class="breadcrumb"
    id="breadcrumb"
    style="
      background: white;
      padding: 12px 20px;
      border-radius: 8px;
      flex: 1;
      font-weight: bold;
      color: #3182ce;
      box-shadow: var(--card-shadow);
    "
  ></div>
</div>

<div class="card-grid" id="categoryGrid"></div>

<div
  id="studentTableContainer"
  style="
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    display: none;
  "
>
  <table style="width: 100%; border-collapse: collapse">
    <thead>
      <tr style="text-align: left; background: #f7fafc">
        <th style="padding: 15px">เลขที่</th>
        <th>ชื่อ-นามสกุล</th>
        <th>เข้าเรียน (ครั้ง)</th>
        <th>สถิติ (%)</th>
      </tr>
    </thead>
    <tbody id="studentTableBody"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let attendanceChart = null;
  const rawData = {{ students_json | safe }};
  let currentPath = [];

  window.addEventListener('DOMContentLoaded', () => { renderView(); });

  function renderView() {
    renderBreadcrumb();
    const backBtn = document.getElementById('backBtn');
    if (backBtn) backBtn.style.display = currentPath.length > 0 ? 'flex' : 'none';

    let displayData = rawData;
    let currentTitle = "ภาพรวมโรงเรียน";

    if (currentPath.length > 0) {
      let groupsL1 = getLevel1Groups(rawData);
      displayData = groupsL1[currentPath[0]] || [];
      currentTitle = currentPath[0];
    }
    if (currentPath.length > 1) {
      let groupsL2 = getLevel2Groups(displayData);
      displayData = groupsL2[currentPath[1]] || [];
      currentTitle = currentPath[1];
    }
    if (currentPath.length > 2) {
      let groupsL3 = getLevel3Groups(displayData);
      displayData = groupsL3[currentPath[2]] || [];
      currentTitle = currentPath[2];
    }

    // อัปเดตกราฟแท่ง และ Ranking
    updateModernCharts(displayData, currentTitle);

    const grid = document.getElementById('categoryGrid');
    const tableContainer = document.getElementById('studentTableContainer');
    const tbody = document.getElementById('studentTableBody');
    grid.innerHTML = '';
    tbody.innerHTML = '';

    if (currentPath.length < 3) {
      tableContainer.style.display = 'none';
      grid.style.display = 'grid';
      let groups, icon;
      if (currentPath.length === 0) { groups = getLevel1Groups(displayData); icon = 'fas fa-school'; }
      else if (currentPath.length === 1) { groups = getLevel2Groups(displayData); icon = 'fas fa-layer-group'; }
      else { groups = getLevel3Groups(displayData); icon = 'fas fa-door-open'; }

      for (let key in groups) { createCard(key, groups[key], icon); }
    } else {
      grid.style.display = 'none';
      tableContainer.style.display = 'block';
      displayData.sort((a, b) => a.roll - b.roll);
      displayData.forEach(s => {
        let color = s.attendance_rate >= 80 ? '#48bb78' : (s.attendance_rate >= 50 ? '#ecc94b' : '#e53e3e');
        tbody.innerHTML += `
          <tr style="border-bottom: 1px solid #edf2f7;">
            <td style="padding: 15px; font-weight: bold;">#${s.roll}</td>
            <td>${s.name}</td>
            <td>${s.present + s.late} / ${s.total_classes} คาบ</td>
            <td><span style="color:${color}; font-weight:bold;">${s.attendance_rate}%</span></td>
          </tr>`;
      });
    }
  }

  function updateModernCharts(data, title) {
    const ctx = document.getElementById('overallChart').getContext('2d');
    const rankingDiv = document.getElementById('rankingList');

    // คำนวณข้อมูลสำหรับกราฟแท่ง (แยกตามกลุ่มย่อย)
    let groups;
    if (currentPath.length === 0) groups = getLevel1Groups(data);
    else if (currentPath.length === 1) groups = getLevel2Groups(data);
    else groups = getLevel3Groups(data);

    let labels = Object.keys(groups);
    let values = labels.map(key => {
        let avg = groups[key].reduce((a, b) => a + b.attendance_rate, 0) / groups[key].length;
        return avg.toFixed(1);
    });

    if (attendanceChart) attendanceChart.destroy();
    attendanceChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '% การเข้าเรียน',
          data: values,
          backgroundColor: '#3182ce',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });

    // อัปเดต Ranking 5 อันดับแรก
    let allRooms = getLevel3Groups(rawData);
    let sortedRooms = Object.keys(allRooms).map(name => {
        let avg = allRooms[name].reduce((a, b) => a + b.attendance_rate, 0) / allRooms[name].length;
        return { name, avg };
    }).sort((a, b) => b.avg - a.avg).slice(0, 5);

    rankingDiv.innerHTML = sortedRooms.map((room, i) => `
      <div class="ranking-item">
        <div class="rank-number">${i+1}</div>
        <div style="flex:1"><b>${room.name}</b></div>
        <div style="color:#48bb78; font-weight:bold;">${room.avg.toFixed(1)}%</div>
      </div>
    `).join('');
  }

  // --- Helper Functions เดิม ---
  function getLevel1Groups(data) {
    let groups = { "ม.ต้น": [], "ม.ปลาย": [] };
    data.forEach(s => {
      if (["ม.1", "ม.2", "ม.3"].some(g => s.classroom.includes(g))) groups["ม.ต้น"].push(s);
      else if (["ม.4", "ม.5", "ม.6"].some(g => s.classroom.includes(g))) groups["ม.ปลาย"].push(s);
    });
    return groups;
  }

  function getLevel2Groups(data) {
    let groups = {};
    data.forEach(s => {
      let grade = s.classroom.split('/')[0].trim();
      if (!groups[grade]) groups[grade] = [];
      groups[grade].push(s);
    });
    return groups;
  }

  function getLevel3Groups(data) {
    let groups = {};
    data.forEach(s => {
      if (!groups[s.classroom]) groups[s.classroom] = [];
      groups[s.classroom].push(s);
    });
    return groups;
  }

  function createCard(title, students, iconClass) {
    let avg = (students.reduce((a, b) => a + b.attendance_rate, 0) / students.length).toFixed(1);
    const card = document.createElement('div');
    card.className = 'level-card';
    card.innerHTML = `<i class="${iconClass}"></i><h3>${title}</h3><p>${students.length} คน</p><div class="stat-badge">${avg}%</div>`;
    card.onclick = () => { currentPath.push(title); renderView(); };
    document.getElementById('categoryGrid').appendChild(card);
  }

  function renderBreadcrumb() {
    const bc = document.getElementById('breadcrumb');
    bc.innerHTML = `<span onclick="goToLevel(-1)"><i class="fas fa-home"></i> โรงเรียน</span>`;
    currentPath.forEach((path, index) => {
      bc.innerHTML += ` <i class="fas fa-chevron-right separator" style="margin:0 10px;"></i> `;
      if (index === currentPath.length - 1) bc.innerHTML += `<span class="current">${path}</span>`;
      else bc.innerHTML += `<span onclick="goToLevel(${index})">${path}</span>`;
    });
  }

  function goBack() { currentPath.pop(); renderView(); }
  function goToLevel(index) { currentPath = index === -1 ? [] : currentPath.slice(0, index + 1); renderView(); }
</script>
{% endblock %}
